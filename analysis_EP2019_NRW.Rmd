---
title: "analysis_EP2019_turnout"
author: "Stefan Hauﬂner"
date: "5 Juni 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(openxlsx)
library(tidyverse)
library(tidyselect)
library(maptools)
library(rgdal)
library(sp)
library(janitor)
library(maps)
library(ggthemes)
library(viridis)
library(data.table)
```

```{r}
deu_str_data <- fread("https://www.bundeswahlleiter.de/dam/jcr/6c6b00b9-750e-456b-8e81-8c45690ec0b7/ew19_strukturdaten.csv",
                      skip = 8, dec = ",") %>% 
  tbl_df() %>% 
  janitor::clean_names()

deu_str_data %>% 
  filter(kreis > 99) %>% 
  select(land, kreis, name, 
         bev_in_1000 = bevolkerung_am_31_12_2017_insgesamt_in_1000, 
         bev_ausl = bevolkerung_am_31_12_2017_auslander_percent, 
         alter_75plus = alter_von_bis_jahren_am_31_12_2017_75_und_mehr_percent,
         alter_u18 = alter_von_bis_jahren_am_31_12_2017_unter_18_percent, 
         inc_p_ew = verfugbares_einkommen_der_privaten_haushalte_2016_je_einwohner,
         edu_absolventen_abi = absolventen_abganger_allgemeinbildender_schulen_2017_mit_allgemeiner_und_fachhochschulreife_percent,
         sgb2 = empfanger_innen_von_leistungen_nach_sgb_ii_oktober_2018_insgesamt_je_1000_einwohner,
         alo_quote = arbeitslosenquote_januar_2019_insgesamt)


spaltennamen_ep19_data <- c("nr","gebiet","gehort_zu","wahlberechtigte","wahlberechtigte_2014","wahler_innen","wahler_innen_2014","ungultige","ungultige_2014","gultige","gultige_2014","christlich_demokratische_union_deutschlands","christlich_demokratische_union_deutschlands_2014","sozialdemokratische_partei_deutschlands","sozialdemokratische_partei_deutschlands_2014","bundnis_90_die_grunen","bundnis_90_die_grunen_2014","die_linke","die_linke_2014","alternative_fur_deutschland","alternative_fur_deutschland_2014","christlich_soziale_union_in_bayern_e_v","christlich_soziale_union_in_bayern_e_v_2014","freie_demokratische_partei","freie_demokratische_partei_2014","freie_wahler","freie_wahler_2014","piratenpartei_deutschland","piratenpartei_deutschland_2014","partei_mensch_umwelt_tierschutz","partei_mensch_umwelt_tierschutz_2014","nationaldemokratische_partei_deutschlands","nationaldemokratische_partei_deutschlands_2014","familien_partei_deutschlands","familien_partei_deutschlands_2014","okologisch_demokratische_partei","okologisch_demokratische_partei_2014","partei_fur_arbeit_rechtsstaat_tierschutz_elitenforderung_und_basisdemokratische_initiative","partei_fur_arbeit_rechtsstaat_tierschutz_elitenforderung_und_basisdemokratische_initiative_2014","ab_jetzt_demokratie_durch_volksabstimmung_politik_fur_die_menschen","ab_jetzt_demokratie_durch_volksabstimmung_politik_fur_die_menschen_2014","bayernpartei","bayernpartei_2014","deutsche_kommunistische_partei","deutsche_kommunistische_partei_2014","marxistisch_leninistische_partei_deutschlands","marxistisch_leninistische_partei_deutschlands_2014","sozialistische_gleichheitspartei_vierte_internationale","sozialistische_gleichheitspartei_vierte_internationale_2014","aktion_partei_fur_tierschutz_das_original","aktion_partei_fur_tierschutz_das_original_2014","allianz_fur_menschenrechte_tier_und_naturschutz","allianz_fur_menschenrechte_tier_und_naturschutz_2014","bundnis_c_christen_fur_deutschland","bundnis_c_christen_fur_deutschland_2014","bundnis_fur_innovation_gerechtigkeit","bundnis_fur_innovation_gerechtigkeit_2014","bundnis_grundeinkommen_die_grundeinkommenspartei","bundnis_grundeinkommen_die_grundeinkommenspartei_2014","demokratie_direkt","demokratie_direkt_2014","demokratie_in_europa_di_em25","demokratie_in_europa_di_em25_2014","der_dritte_weg","der_dritte_weg_2014","die_grauen_fur_alle_generationen","die_grauen_fur_alle_generationen_2014","die_rechte_partei_fur_volksabstimmung_souveranitat_und_heimatschutz","die_rechte_partei_fur_volksabstimmung_souveranitat_und_heimatschutz_2014","die_violetten","die_violetten_2014","europaische_partei_liebe","europaische_partei_liebe_2014","feministische_partei_die_frauen","feministische_partei_die_frauen_2014","graue_panther","graue_panther_2014","lkr_bernd_lucke_und_die_liberal_konservativen_reformer","lkr_bernd_lucke_und_die_liberal_konservativen_reformer_2014","menschliche_welt_fur_das_wohl_und_glucklichsein_aller","menschliche_welt_fur_das_wohl_und_glucklichsein_aller_2014","neue_liberale_die_sozialliberalen","neue_liberale_die_sozialliberalen_2014","okologische_linke","okologische_linke_2014","partei_der_humanisten","partei_der_humanisten_2014","partei_fur_die_tiere_deutschland","partei_fur_die_tiere_deutschland_2014","partei_fur_gesundheitsforschung","partei_fur_gesundheitsforschung_2014","volt_deutschland","volt_deutschland_2014","ubrige","ubrige_2014","v96")

deu_ep19_download <- fread("https://www.bundeswahlleiter.de/dam/jcr/095b092a-780e-45e1-aca9-caafe903b126/ew19_kerg.csv",
                       skip = 2, dec = ",", encoding = "UTF-8", blank.lines.skip = TRUE, fill = TRUE, sep = ";") %>% 
  tbl_df() %>% 
  filter(!is.na(Nr)) %>% 
  filter(Nr > 99) %>% 
  janitor::clean_names() %>% 
  rename_all(~ spaltennamen_ep19_data) %>% 
  select(-v96)
 
deu_ep14_data <- deu_ep19_download %>% select(nr, gebiet, gehort_zu, contains("_2014"), -ubrige_2014) %>% 
  rename_at(.vars = vars(ends_with("_2014")),
            .funs = funs(sub("_2014","",.))) %>%
  mutate_at(vars(wahlberechtigte:volt_deutschland), funs(as.numeric(.))) %>% 
  tbl_df() %>% 
  mutate_at(vars(christlich_demokratische_union_deutschlands:volt_deutschland), funs(./gultige*100)) %>% 
  mutate(turnout = wahler_innen/wahlberechtigte*100)

deu_ep19_data <- deu_ep19_download %>% select(-contains("_2014"), nr, gebiet, gehort_zu, -ubrige) %>% 
  mutate_at(vars(wahlberechtigte:volt_deutschland), funs(as.numeric(.))) %>% 
  tbl_df() %>% 
  mutate_at(vars(christlich_demokratische_union_deutschlands:volt_deutschland), funs(./gultige*100)) %>% 
  mutate(turnout = wahler_innen/wahlberechtigte*100)

            
```

```{r}
deu_ep19_data_long <- deu_ep19_data %>% 
  select(gehort_zu, turnout, christlich_demokratische_union_deutschlands:volt_deutschland) %>%
  group_by(gehort_zu) %>% 
  reshape2::melt(id.vars = c("gehort_zu", "turnout"))

## Deutschland gesamt
ggplot(deu_ep19_data_long) +
  #geom_point(aes(x = turnout, y = value)) +
  geom_smooth(aes(x = turnout, y = value), method = "lm", se = TRUE)+
  facet_wrap(~ variable, scales = "free_y")

## NRW
deu_ep19_data_long %>% 
  filter(gehort_zu == 5) %>% 
ggplot() +
  geom_smooth(aes(x = turnout, y = value), method = "lm", se = TRUE)+
  facet_wrap(~ variable, scales = "free_y")
```

